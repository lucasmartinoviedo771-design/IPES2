{% extends "ui/base.html" %}
{% load static form_extras %}

{% block title %}Cargar horarios · IPES{% endblock %}
{% block nav_horario %}active{% endblock %}

{% block content %}
<div class="panel">
  <h1>Cargar horarios</h1>

  <form id="frm-horario"
        method="post"
        action="{{ request.path }}"
        data-planes-url="{% url 'ui:api_planes' %}"
        data-materias-url="{% url 'ui:api_materias' %}"
        data-docentes-url="{% url 'ui:api_docentes' %}"
        data-ocupados-url="{% url 'ui:api_horarios_ocupados' %}">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="form-grid-2">
      <div>
        <label for="id_carrera">Profesorado / Carrera</label>
        <select id="id_carrera" name="carrera" class="select">
          <option value="">---------</option>
          {% for c in carreras %}
          <option value="{{ c.id }}">{{ c.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="id_plan">Plan</label>
        <select id="id_plan" name="plan" class="select" disabled>
          <option value="">---------</option>
        </select>
      </div>

      <div>
        <label for="id_materia">Materia</label>
        <select id="id_materia" name="materia" class="select" disabled>
          <option value="">---------</option>
        </select>
        <div id="materia-meta" class="muted" style="margin-top:6px"></div>
      </div>

      <div>
        <label for="id_turno">Turno</label>
        <select id="id_turno" name="turno" class="select" disabled>
          <option value="">---------</option>
          <option value="M">Mañana</option>
          <option value="T">Tarde</option>
          <option value="N">Noche</option>
        </select>
      </div>

      <div>
        <label for="id_docente">Docente</label>
        <select id="id_docente" name="docente" class="select" disabled>
          <option value="">Sin designar</option>
        </select>
      </div>

      <div>
        <label for="id_aula">Aula (opcional)</label>
        <select id="id_aula" name="aula" class="select">
          <option value="">---------</option>
          {% for a in aulas %}
          <option value="{{ a.id }}">{{ a.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="grid-span-2">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">Seleccionar franjas horarias</h2>
          <div class="muted">
            Horas presenciales seleccionadas:
            <strong id="horas-sel">0</strong>/<span id="horas-max">0</span>
          </div>
        </div>

        <div id="slot-legend" class="muted" style="margin:6px 0 8px">
          Toque los cuadros para agregar/quitar. Los de color claro son recreos.
        </div>

        <div id="slot-grid" class="table-wrap"></div>
        <input type="hidden" name="slots" id="id_slots" value="">
        <div id="slot-errors" class="help-error" style="display:none"></div>
      </div>

      <div class="grid-span-2">
        <label for="id_observaciones">Observaciones</label>
        <textarea id="id_observaciones" name="observaciones" class="input" rows="2"></textarea>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" type="submit">Guardar</button>
      <a class="btn btn-ghost" href="{% url 'academia_horarios:oferta_list' %}">Cancelar</a>
    </div>
  </form>
</div>

<script>
/*** === CONFIG DE SLOTS POR TURNO (incluye recreos) ===
 *  Si ya tenías esto en JS/HTML, copiá acá los mismos horarios o
 *  movelos a un endpoint para centralizarlos.
 */
const SLOTS = {
  'M': [
    {ini:'07:45',fin:'08:30'},{ini:'08:30',fin:'09:15'},{break:true,ini:'09:15',fin:'09:30'},
    {ini:'09:30',fin:'10:15'},{ini:'10:15',fin:'11:00'},{break:true,ini:'11:00',fin:'11:10'},
    {ini:'11:10',fin:'11:55'},{ini:'11:55',fin:'12:40'}
  ],
  'T': [
    {ini:'13:30',fin:'14:15'},{ini:'14:15',fin:'15:00'},{break:true,ini:'15:00',fin:'15:15'},
    {ini:'15:15',fin:'16:00'},{ini:'16:00',fin:'16:45'},{break:true,ini:'16:45',fin:'16:55'},
    {ini:'16:55',fin:'17:40'},{ini:'17:40',fin:'18:25'}
  ],
  'N': [
    {ini:'18:30',fin:'19:15'},{ini:'19:15',fin:'20:00'},{break:true,ini:'20:00',fin:'20:15'},
    {ini:'20:15',fin:'21:00'},{ini:'21:00',fin:'21:45'}
  ]
};

// Días: L..S (0=Lunes)
const DIAS = [
  {k:0, t:'Lun'}, {k:1, t:'Mar'}, {k:2, t:'Mié'}, {k:3, t:'Jue'}, {k:4, t:'Vie'}, {k:5, t:'Sáb'}
];

(function(){
  const form = document.getElementById('frm-horario');
  if(!form) return;

  const selCarrera = document.getElementById('id_carrera');
  const selPlan    = document.getElementById('id_plan');
  const selMateria = document.getElementById('id_materia');
  const selTurno   = document.getElementById('id_turno');
  const selDocente = document.getElementById('id_docente');
  const selAula    = document.getElementById('id_aula');

  const horasMaxEl = document.getElementById('horas-max');
  const horasSelEl = document.getElementById('horas-sel');
  const slotsHidden= document.getElementById('id_slots');
  const slotGrid   = document.getElementById('slot-grid');
  const slotErr    = document.getElementById('slot-errors');
  const materiaMeta= document.getElementById('materia-meta');

  let materiaInfo = { horas_presenciales:0, horas_rotativas:0, es_practica:false };
  let ocupados = []; // [{dia:0, ini:'07:45', fin:'08:30', tipo:'docente|aula'}]

  function setErr(msg){
    slotErr.style.display = msg ? 'block' : 'none';
    slotErr.textContent   = msg || '';
  }

  function jsonGet(url, params){
    const q = new URLSearchParams(params||{}).toString();
    return fetch(q? `${url}?${q}` : url, {headers:{'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.ok?r.json():Promise.reject(r.statusText));
  }

  // 1) cascada: carrera -> planes
  selCarrera.addEventListener('change', () => {
    resetBelow('carrera');
    const id = selCarrera.value;
    if(!id) return;
    jsonGet(form.dataset.planesUrl, {carrera:id}).then(data=>{
      fillSelect(selPlan, data.results, true);
      selPlan.disabled = false;
    });
  });

  // 2) cascada: plan -> materias (también horas semanales / práctica)
  selPlan.addEventListener('change', () => {
    resetBelow('plan');
    const id = selPlan.value;
    if(!id) return;
    jsonGet(form.dataset.materiasUrl, {plan:id}).then(data=>{
      fillSelect(selMateria, data.results, true);
      selMateria.disabled = false;
    });
  });

  // 3) materia -> meta + turno habilitado + docentes
  selMateria.addEventListener('change', () => {
    resetBelow('materia');
    const opt = selMateria.selectedOptions[0];
    if(!opt) return;

    // la API de materias puede devolver meta por id; acá meta via data-attrs opcional
    materiaInfo = {
      horas_presenciales: Number(opt.dataset.horas || 0),
      horas_rotativas: Number(opt.dataset.rot || 0),
      es_practica: opt.dataset.prac === '1'
    };
    horasMaxEl.textContent = materiaInfo.horas_presenciales || 0;
    horasSelEl.textContent = '0';
    materiaMeta.textContent = metaText(materiaInfo);

    selTurno.disabled = false;

    // docentes
    jsonGet(form.dataset.docentesUrl, {carrera: selCarrera.value, materia: selMateria.value})
      .then(data=>{
        fillSelect(selDocente, [{id:'', nombre:'Sin designar'}, ...data.results], false);
        selDocente.disabled = false;
      });
  });

  function metaText(meta){
    if (!meta.horas_presenciales) return '';
    if (meta.es_practica){
      return `Presenciales: ${meta.horas_presenciales} hs · Rotativas: ${meta.horas_rotativas || 0} hs`;
    }
    return `Presenciales semanales: ${meta.horas_presenciales} hs`;
  }

  // 4) turno -> dibujar grilla + cargar ocupados
  selTurno.addEventListener('change', buildGrid);

  // 5) docente/aula cambian -> recargar ocupados para bloquear celdas
  [selDocente, selAula].forEach(el=>{
    el.addEventListener('change', markOcupados);
  });

  function fillSelect(sel, items, addEmpty){
    sel.innerHTML = '';
    if(addEmpty) sel.append(new Option('---------', ''));
    for (const it of items){
      sel.append(new Option(it.nombre || it.text || it.label, it.id));
    }
  }

  function resetBelow(level){
    if(level==='carrera'){
      selPlan.innerHTML    = '<option value="">---------'</option>';
      selPlan.disabled     = true;
    }
    if(level==='carrera' || level==='plan'){
      selMateria.innerHTML = '<option value="">---------'</option>';
      selMateria.disabled  = true;
      materiaMeta.textContent='';
      materiaInfo = {horas_presenciales:0, horas_rotativas:0, es_practica:false};
      horasMaxEl.textContent='0'; horasSelEl.textContent='0';
    }
    if(level!=='turno'){
      selTurno.value='';
      selTurno.disabled = true;
    }
    selDocente.innerHTML = '<option value="">Sin designar</option>';
    selDocente.disabled = true;
    clearGrid();
  }

  function clearGrid(){
    slotGrid.innerHTML = '';
    slotsHidden.value = '';
    setErr('');
  }

  function buildGrid(){
    clearGrid();
    const t = selTurno.value;
    if(!t) return;

    const rows = SLOTS[t] || [];
    if(!rows.length) return;

    // tabla
    const tbl = document.createElement('table');
    tbl.className = 'table';
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    trh.append(th('Hora'));
    DIAS.forEach(d => trh.append(th(d.t)));
    thead.append(trh); tbl.append(thead);

    const tbody = document.createElement('tbody');
    rows.forEach((slot, idx) => {
      const tr = document.createElement('tr');
      tr.append(td(`${slot.ini}–${slot.fin}${slot.break?' · recreo':''}`));
      DIAS.forEach(d => {
        const celda = document.createElement('td');
        celda.dataset.dia = d.k;
        celda.dataset.ini = slot.ini;
        celda.dataset.fin = slot.fin;
        if(slot.break){ celda.style.opacity=.45; celda.style.pointerEvents='none'; }
        else {
          celda.addEventListener('click', () => toggleCell(celda));
          celda.style.cursor='pointer';
        }
        tr.append(celda);
      });
      tbody.append(tr);
    });
    tbl.append(tbody);
    slotGrid.append(tbl);

    // traer ocupados y marcarlos
    markOcupados();
  }

  function th(t){ const e=document.createElement('th'); e.textContent=t; return e; }
  function td(t){ const e=document.createElement('td'); e.textContent=t; return e; }

  function toggleCell(td){
    const sel = td.classList.toggle('bg-select'); // usa tu color por CSS si querés
    // serializamos a hidden
    const list = getSelected();
    slotsHidden.value = JSON.stringify(list);
    horasSelEl.textContent = list.length;

    const max = Number(horasMaxEl.textContent||0);
    if (max && list.length > max){
      setErr(`Supera el máximo de ${max} horas presenciales por semana para la materia.`);
    } else {
      setErr('');
    }
  }

  function getSelected(){
    const out=[];
    slotGrid.querySelectorAll('td.bg-select').forEach(td=>{
      out.push({
        dia: Number(td.dataset.dia),
        ini: td.dataset.ini,
        fin: td.dataset.fin
      });
    });
    return out;
  }

  function markOcupados(){
    const carrera = selCarrera.value;
    const plan    = selPlan.value;
    const materia = selMateria.value;
    const turno   = selTurno.value;
    const docente = selDocente.value || ''; // vacío = sin designar
    const aula    = selAula.value || '';

    if(!turno) return;

    jsonGet(form.dataset.ocupadosUrl, {carrera, plan, materia, turno, docente, aula})
      .then(data=>{
        ocupados = data.ocupados || [];
        // deshabilitar celdas que choquen
        slotGrid.querySelectorAll('tbody td').forEach(td=>{
          if(!td.dataset.ini) return;
          const dia = Number(td.dataset.dia);
          const ini = td.dataset.ini;
          const fin = td.dataset.fin;

          const busy = ocupados.some(x => String(x.dia)===String(dia) && x.ini===ini && x.fin===fin);
          td.style.background = busy ? '#f7e4e1' : ''; // rojo suave
          td.style.pointerEvents = busy ? 'none' : 'auto';
          if(busy) td.classList.remove('bg-select');
        });
        // actualizar hidden/contador
        const list = getSelected();
        slotsHidden.value = JSON.stringify(list);
        horasSelEl.textContent = list.length;
      });
  }

  // Submit: reglas básicas
  form.addEventListener('submit', (e)=>{
    const max = Number(horasMaxEl.textContent||0);
    const list = getSelected();
    if(!selCarrera.value || !selPlan.value || !selMateria.value || !selTurno.value){
      e.preventDefault(); setErr('Completá Carrera, Plan, Materia y Turno.'); return;
    }
    if(max && list.length > max){
      e.preventDefault(); setErr(`Supera el máximo de ${max} horas presenciales.`); return;
    }
    if(!list.length){
      e.preventDefault(); setErr('Seleccioná al menos una franja horaria.'); return;
    }
  });

})();
</script>
<style>
/* selección visual de celdas */
#slot-grid td.bg-select{ box-shadow: inset 0 0 0 2px var(--accent); background:#fffaf5; }
</style>
{% endblock %}