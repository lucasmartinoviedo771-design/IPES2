{% extends "ui/base.html" %}
{% load static form_extras %}

{% block title %}Cargar horarios · IPES{% endblock %}
{% block nav_horario %}active{% endblock %}

{% block content %}
<div class="panel">
  <h1>Cargar horarios</h1>

  <form id="frm-horario"
        method="post"
        action="{{ request.path }}"
        data-planes-url="{% url 'ui:api_planes' %}"
        data-materias-url="{% url 'ui:api_materias' %}"
        data-docentes-url="{% url 'ui:api_docentes' %}"
        data-ocupados-url="{% url 'ui:api_horarios_ocupados' %}">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="form-grid-2">
      <div>
        <label for="id_carrera">Profesorado / Carrera</label>
        <select id="id_carrera" name="carrera" class="select">
          <option value="">---------</option>
          {% for c in carreras %}
          <option value="{{ c.id }}">{{ c.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="id_plan">Plan</label>
        <select id="id_plan" name="plan" class="select" disabled>
          <option value="">---------</option>
        </select>
      </div>

      <div>
        <label for="id_materia">Materia</label>
        <select id="id_materia" name="materia" class="select" disabled>
          <option value="">---------</option>
        </select>
        <div id="materia-meta" class="muted" style="margin-top:6px"></div>
      </div>

      <div>
        <label for="id_turno">Turno</label>
        <select id="id_turno" name="turno" class="select" disabled>
          <option value="">---------</option>
          <option value="M">Mañana</option>
          <option value="T">Tarde</option>
          <option value="N">Noche</option>
        </select>
      </div>

      <div>
        <label for="id_docente">Docente</label>
        <select id="id_docente" name="docente" class="select" disabled>
          <option value="">Sin designar</option>
        </select>
      </div>

      <div>
        <label for="id_aula">Aula (opcional)</label>
        <select id="id_aula" name="aula" class="select">
          <option value="">---------</option>
          {% for a in aulas %}
          <option value="{{ a.id }}">{{ a.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      {# NEW SECTION SELECT #}
      <div>
        <label for="id_seccion">Comisión / Sección</label>
        <select id="id_seccion" name="seccion" class="select">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
      </div>
      {# END NEW SECTION SELECT #}

      <div class="grid-span-2">
        <h2 style="margin:0">Seleccionar franjas horarias</h2>
        <div id="horas-head" class="muted" style="margin:8px 0 6px">
          Horas presenciales seleccionadas:
          <strong><span id="horas-sel">0</span>/<span id="horas-req">0</span></strong>
        </div>
        <div id="grid-horarios" class="slots-grid"></div>
        <input type="hidden" name="franjas_json" id="id_franjas_json">
      </div>

      <div class="grid-span-2">
        <label for="id_observaciones">Observaciones</label>
        <textarea id="id_observaciones" name="observaciones" class="input" rows="2"></textarea>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" type="submit">Guardar</button>
      <a class="btn btn-ghost" href="{% url 'academia_horarios:panel_oferta' %}">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

<!-- Debugging Toast -->
<style>
  .debug-toast{ position:fixed; right:16px; bottom:16px; z-index:99999; background:#fff; border:1px solid #d97706; color:#7c2d12; box-shadow:0 4px 16px rgba(0,0,0,.12); border-radius:10px; padding:12px 14px; max-width:520px; font-size:13px; line-height:1.35; }
  .debug-toast h4{ margin:0 0 6px; font-size:13px; font-weight:700; color:#9a3412;}
  .debug-toast code{display:block; white-space:pre-wrap; background:#fff7ed; border:1px solid #fed7aa; padding:6px 8px; border-radius:6px; color:#7c2d12;}
</style>
<div id="debug-toast" class="debug-toast" style="display:none" onclick="this.style.display='none'"></div>

{% block extra_js %}
<script>
/* Endpoints: injectados por Django */
const API_PLANES   = "{% url 'ui:api_planes' %}";
const API_MATERIAS = "{% url 'ui:api_materias' %}";
const API_DOCENTES = "{% url 'ui:api_docentes' %}";

const absURL = (path) => new URL(path, window.location.origin);

// Selects
const selCarrera   = document.getElementById('id_carrera');     // Profes./Carrera
const selPlan      = document.getElementById('id_plan');        // Plan
const selMateria   = document.getElementById('id_materia');     // Materia
const selTurno     = document.getElementById('id_turno');       // Turno
const selDocente   = document.getElementById('id_docente');     // Docente

/* Utilidad: opciones + estado */
function setOptions(select, items, getValue, getLabel) {
  select.innerHTML = '';
  const ph = document.createElement('option');
  ph.value = '';
  ph.textContent = '--------';
  select.appendChild(ph);
  for (const it of items) {
    const op = document.createElement('option');
    op.value = String(getValue(it));
    op.textContent = getLabel(it);
    select.appendChild(op);
  }
}

function setLoading(select, text='Cargando…') {
  select.innerHTML = '';
  const op = document.createElement('option');
  op.value = '';
  op.textContent = text;
  select.appendChild(op);
}

/* Banner de error visible */
function flashError(msg) {
  let bar = document.getElementById('ui-flash-error');
  if (!bar) {
    bar = Object.assign(document.createElement('div'), { id:'ui-flash-error' });
    bar.style.cssText =
      'position:fixed;top:10px;left:50%;transform:translateX(-50%);'+
      'background:#b45309;color:#fff;padding:8px 12px;border-radius:8px;'+
      'box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:9999;font:14px/1.2 system-ui';
    document.body.appendChild(bar);
  }
  bar.textContent = msg;
  bar.style.display = 'block';
  setTimeout(()=> bar.style.display='none', 4000);
}

/* fetch con logs */
async function fetchJSONDebug(url, opts={}) {
  console.log('[fetch]', url.toString());
  const res = await fetch(url, opts);
  if (!res.ok) {
    let txt = '';
    try { txt = await res.text(); } catch {}
    console.error('[fetch error]', res.status, txt);
    throw new Error(`${res.status} ${txt || res.statusText}`);
  }
  return res.json();
}

/* Extraer plan_id de forma robusta */
function getPlanId() {
  // 1) value (lo normal si setOptions puso id)
  if (selPlan && selPlan.value && selPlan.value !== '--------') return selPlan.value;

  // 2) data-id en la opción seleccionada
  const opt = selPlan?.selectedOptions?.[0];
  if (opt?.dataset?.id) return opt.dataset.id;

  // 3) si el texto del option es un número, úsalo
  const txt = opt?.textContent?.trim();
  if (txt && /^\d+$/.test(txt)) return txt;

  return '';
}

/* Cargar materias del plan seleccionado */
async function updateMaterias() {
  const carreraId = selCarrera?.value;
  const planId = getPlanId();

  console.log('[updateMaterias] carreraId=', carreraId, 'planId=', planId);
  if (!carreraId) { console.log('[updateMaterias] no carreraId'); setOptions(selMateria, [], x=>x.id, x=>x.nombre); return; }
  if (!planId)     { console.log('[updateMaterias] no planId');   setOptions(selMateria, [], x=>x.id, x=>x.nombre); return; }

  setLoading(selMateria);

  try {
    const u = new URL(API_MATERIAS, location.origin);
    u.searchParams.set('carrera', carreraId);
    u.searchParams.set('plan_id', planId);        // <- clave correcta

    const data = await fetchJSONDebug(u);
    console.log('[updateMaterias] materias:', data);

    setOptions(selMateria, data.results, it => it.id, it => it.nombre || it.codigo || `#${it.id}`);
    selMateria.disabled = false;
  } catch (e) {
    flashError('No pude cargar materias: ' + e.message);
    console.error(e);
    setOptions(selMateria, [], x=>x.id, x=>x.nombre);
    selMateria.disabled = false;
  }
}

/* Enlace de eventos */
selCarrera?.addEventListener('change', async () => {
  // cargar planes y luego materias
  try {
    setLoading(selPlan, 'Cargando planes…');
    const uPlanes = absURL(API_PLANES);
    uPlanes.searchParams.set('carrera', selCarrera.value);
    const data = await fetchJSONDebug(uPlanes);
    console.log('[updatePlanes] planes:', data.results);
    setOptions(selPlan, data.results, it => it.id, it => it.codigo || it.nombre || `#${it.id}`);
    selPlan.disabled = false;
  } catch (e) {
    flashError('No pude cargar planes: ' + e.message);
    console.error(e);
    setOptions(selPlan, [], it=>it.id, it=>it.nombre);
  }
  await updateMaterias();
});

selPlan?.addEventListener('change', updateMaterias);

/* Arranque: si ya hay carrera/plan seleccionados, dispara materias */
document.addEventListener('DOMContentLoaded', () => {
  console.log('[init] carrera=', selCarrera?.value, 'plan(value)=', selPlan?.value);
  if (selCarrera?.value) {
      selCarrera.dispatchEvent(new Event('change'));
  }
});
</script>
{% endblock %}