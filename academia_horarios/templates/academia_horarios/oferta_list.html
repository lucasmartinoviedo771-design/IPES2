{% extends 'academia_horarios/base_panel.html' %}
{% load static %}
{% block title %}Oferta por Plan/Año/Período{% endblock %}
{% block content %}
<form method="get" class="grid">
  <label>Plan
    <select name="plan">
      <option value="">--</option>
      {% for p in planes %}
        <option value="{{p.id}}" {% if plan_sel == p.id %}selected{% endif %}>{{p}}</option>
      {% endfor %}
    </select>
  </label>
  <label for="f_anio">Año</label>
<select id="f_anio" name="anio">
  <option value="">--</option>
  {% for a in anios %}
    <option value="{{ a }}"
      {% if request.GET.anio|stringformat:"s" == a|stringformat:"s" %}selected{% endif %}>
      {{ a }}°
    </option>
  {% endfor %}
</select>
  <label>Período
    <select name="periodo">
      <option value="">--</option>
      {% for per in periodos %}
        <option value="{{per.id}}" {% if periodo_sel == per.id %}selected{% endif %}>{{per}}</option>
      {% endfor %}
    </select>
  </label>
  <button>Filtrar</button>
</form>

{% if rows %}
  <form method="post" style="margin:.5rem 0;">{% csrf_token %}
    <input type="hidden" name="action" value="desdoblar"/>
    <input type="hidden" name="plan" value="{{plan_sel}}"/>
    <input type="hidden" name="anio" value="{{anio_sel}}"/>
    <input type="hidden" name="periodo" value="{{periodo_sel}}"/>
    <label>Crear comisión para todas las materias: <input name="nombre" placeholder="B" value="B" style="width:6rem"/></label>
    <button>Desdoblar año</button>
  </form>

  <table>
    <thead><tr><th>Materia</th><th>HC req.</th><th>HC asig.</th><th>Estado</th><th>Acciones</th></tr></thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.mep.materia }} ({{ r.mep.tipo_dictado }})</td>
        <td>{{ r.requeridas }}</td>
        <td>{{ r.asignadas }}</td>
        <td>
          {% if r.estado == 'ok' %}<span style="color:green">✔ Completo</span>
          {% elif r.estado == 'faltan' %}<span style="color:#b58900">⚠ Faltan</span>
          {% else %}<span style="color:#dc322f">⛔ Excedido</span>
          {% endif %}
        </td>
        <td>
          {% if r.comision %}
            <a href="{% url 'panel_comision' r.comision.id %}">Administrar comisión</a>
          {% else %}
            <em>Sin comisión Única. Creá una:</em>
            <form method="post" style="display:inline">{% csrf_token %}
              <input type="hidden" name="action" value="crear_unica"/>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}
{% endblock %}
