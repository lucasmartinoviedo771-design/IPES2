{% extends 'academia_horarios/base_panel.html' %}
{% load static %}
{% block title %}{{ object }}{% endblock %}
{% block content %}
{% if horas_tope is not None %}
  <p><strong>Carga semanal:</strong> {{ horas_asignadas }}/{{ horas_tope }}
    {% if bloqueado_por_tope %}
      <span style="background-color: var(--pico-amber-200);">Tope alcanzado</span>
    {% endif %}
  </p>
{% else %}
  <p><em>Sin tope configurado para esta materia.</em></p>
{% endif %}

<h3>Horarios</h3>
<table>
  <thead><tr><th>Día</th><th>Inicio</th><th>Fin</th><th>Docentes</th><th>Aula</th><th></th></tr></thead>
  <tbody>
  {% for h in horarios %}
    <tr>
      <td>{{ h.timeslot.get_dia_semana_display }}</td>
      <td>{{ h.timeslot.inicio }}</td>
      <td>{{ h.timeslot.fin }}</td>
      <td>{% for d in h.docentes.all %}{{ d }}{% if not forloop.last %}, {% endif %}{% empty %}<em>Sin docente</em>{% endfor %}</td>
      <td>{{ h.aula }}</td>
      <td>
        <a href="{% url 'panel_horario_del' h.id %}">Borrar</a>
      </td>
    </tr>
  {% empty %}
    <tr><td colspan="6">No hay horarios.</td></tr>
  {% endfor %}
  </tbody>
</table>

<h3>Agregar horario</h3>
<form method="post">{% csrf_token %}

  {% if messages %}
    {% for m in messages %}
      <div class="alert {{ m.tags }}">{{ m }}</div>
    {% endfor %}
  {% endif %}

  {% if form.errors %}
    <div class="alert error">
      <p>Form errors: {{ form.errors }}</p>
    </div>
  {% endif %}

  <div class="grid">
    <div>
      <label for="id_turno">Turno</label>
      <select id="id_turno" name="turno">
        <option value="">— (todos) —</option>
        <option value="M">Mañana</option>
        <option value="T">Tarde</option>
        <option value="V">Vespertino</option>
        <option value="S">Sábado</option>
      </select>
    </div>

    <div>
      <label for="id_dia">Día</label>
      <select id="id_dia" name="dia">
        <option value="">— (todos) —</option>
        <option value="1">Lunes</option>
        <option value="2">Martes</option>
        <option value="3">Miércoles</option>
        <option value="4">Jueves</option>
        <option value="5">Viernes</option>
        <option value="6">Sábado</option>
      </select>
    </div>
  </div>

  <div>
    <label for="id_bloque">Bloque (día / inicio–fin)</label>
    <select id="id_bloque" name="bloque" required>
      <option value="">— seleccioná turno/día —</option>
    </select>
    {% if form.bloque.errors %}
      <div class="error">{{ form.bloque.errors|join:", " }}</div>
    {% endif %}
  </div>

  <label>Aula {{ form.aula }}</label>
  <label for="id_docentes">
  Docentes (opcional) <small id="docCount" class="contrast"></small>
</label>

{{ form.docentes }}

<small id="docHelp" class="muted">
  Consejo: para seleccionar más de un docente mantené presionada
  <kbd>Ctrl</kbd> (Windows/Linux) o <kbd>⌘ Cmd</kbd> (Mac) mientras hacés clic.
</small>

<!-- Resumen vivo -->
<div id="docentesSummary" class="summary-chips" aria-live="polite"></div>

  <button {% if bloqueado_por_tope %}disabled title="Tope de horas alcanzado"{% endif %}>Agregar</button>
</form>

{% comment %}
{# --- Asignar docente --- #}
<form method="post" action="{% url 'ui:asignar_docente' pk=comision.id %}">
  {% csrf_token %}
  <label>Docente:</label>
  <select name="docente_id" required>
    <option value="">-- elegir --</option>
    {% for d in docentes %}
      <option value="{{ d.id }}">{{ d.apellido_nombre }}</option>
    {% endfor %}
  </select>
  <button type="submit">Asignar docente</button>
</form>
{% endcomment %}



<script>
async function cargarBloques() {
  const turno = document.getElementById("id_turno").value;
  const dia   = document.getElementById("id_dia").value;
  const params = new URLSearchParams();
  if (turno) params.append("turno", turno);
  if (dia)   params.append("dia", dia);

  const resp = await fetch(`/panel/horarios/api/timeslots/?${params.toString()}`);
  const data = await resp.json();

  const sel = document.getElementById("id_bloque");
  sel.innerHTML = "";
  if (!data.results.length) {
    sel.innerHTML = `<option value=""> (no hay bloques con ese filtro)</option>`;
    return;
  }
  for (const x of data.results) {
    const opt = document.createElement("option");
    opt.value = x.id;
    opt.textContent = x.label;
    sel.appendChild(opt);
  }
}

document.getElementById("id_turno").addEventListener("change", cargarBloques);
document.getElementById("id_dia").addEventListener("change", cargarBloques);

// carga inicial (por si querés que arranque con todos)
cargarBloques();
</script>

<style>
.summary-chips {
  display: flex;
  flex-wrap: wrap;
  gap: .35rem;
  margin-top: .35rem;
}
.summary-chips .chip {
  padding: .2rem .5rem;
  border-radius: 999px;
  border: 1px solid var(--muted-border-color, #334155);
  background: var(--muted-bg, #1f2937);
  font-size: .85rem;
}
.muted { opacity: .8; }
kbd {
  background: #111827; border: 1px solid #374151; border-radius: .25rem;
  padding: .1rem .35rem; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size: .85em;
}
</style>
{% endblock %}
